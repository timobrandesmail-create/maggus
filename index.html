<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="theme-color" content="#0ea5e9">
<title>Finanz-T√úV</title>
<style>
  :root{
    --bg:#0b1220; --panel:rgba(255,255,255,.06); --ink:#e5e7eb; --muted:#94a3b8; --ring:rgba(255,255,255,.12);
    --brand:#22d3ee; --good:#10b981; --warn:#f59e0b; --bad:#ef4444; --r:16px;
  }
  @media (prefers-color-scheme: light){
    :root{ --bg:#f8fafc; --panel:#ffffff; --ink:#0f172a; --muted:#64748b; --ring:#e2e8f0 }
  }
  *{box-sizing:border-box}
  body{margin:0; font:16px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto; background:var(--bg); color:var(--ink);}
  a,button{cursor:pointer}
  .wrap{max-width:980px; margin:0 auto; padding:18px 16px calc(env(safe-area-inset-bottom)+18px)}
  .hero{display:grid; place-items:center; min-height:55vh; text-align:center}
  .logo{width:52px; height:52px; border-radius:14px; background:conic-gradient(from 200deg,#67e8f9,#a78bfa,#67e8f9); margin:0 auto 10px}
  h1{margin:6px 0 4px; font-size:28px}
  p.lead{color:var(--muted); max-width:50ch; margin:0 auto 16px}
  .btn{height:48px; padding:0 18px; border-radius:12px; border:1px solid var(--ring); background:linear-gradient(135deg,#06b6d4,#22d3ee); color:#001019; font-weight:700}
  .btn.ghost{background:rgba(255,255,255,.06); color:var(--ink)}
  .panel{background:var(--panel); border:1px solid var(--ring); border-radius:var(--r); padding:14px}
  .grid{display:grid; gap:12px}
  .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  @media(min-width:860px){ .grid2{grid-template-columns:repeat(2,1fr)} }
  label{font-size:12px; color:var(--muted); display:block; margin:0 0 6px 2px}
  input[type=number]{width:100%; height:48px; border-radius:12px; border:1px solid var(--ring); background:transparent; color:var(--ink); padding:0 12px; font-size:16px}
  /* Pages */
  .page{display:none} .page.active{display:block}
  /* Wizard */
  .wizardHead{display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:8px}
  .progress{position:relative; height:10px; background:rgba(255,255,255,.08); border-radius:999px; overflow:hidden}
  .bar{position:absolute; left:0; top:0; bottom:0; width:0%; background:linear-gradient(90deg,#06b6d4,#22d3ee); transition:width .25s}
  .pct{font-size:12px; color:var(--muted)}
  .cat{border:1px dashed var(--ring); border-radius:14px; padding:10px}
  .cat h3{margin:0 0 8px; font-size:15px}
  .nav{display:flex; justify-content:space-between; gap:8px; margin-top:10px}
  /* Results */
  .kpis{display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:10px}
  .kpi{border:1px solid var(--ring); border-radius:12px; padding:12px; background:rgba(255,255,255,.05)}
  .lab{font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:.06em}
  .val{font-weight:800; font-size:20px}
  .legend{display:flex; flex-wrap:wrap; gap:10px; margin-top:6px}
  .dot{width:10px; height:10px; border-radius:50%}
  canvas{max-width:100%}
  .cols{display:grid; gap:12px}
  @media(min-width:860px){ .cols{grid-template-columns: 2fr 1fr} }
  .muted{color:var(--muted)}
  .badge{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; border:1px solid var(--ring); background:rgba(255,255,255,.06); font-weight:700}
  .grade{display:inline-block; min-width:28px; text-align:center; border-radius:8px; padding:2px 6px; font-weight:800}
  .gA{background:#10b9811a; color:#10b981; border:1px solid #10b98166}
  .gB{background:#22d3ee1a; color:#22d3ee; border:1px solid #22d3ee66}
  .gC{background:#f59e0b1a; color:#f59e0b; border:1px solid #f59e0b66}
  .gD{background:#ef44441a; color:#ef4444; border:1px solid #ef444466}
</style>
</head>
<body>
<div class="wrap">

  <!-- Landing -->
  <section id="landing" class="page active">
    <div class="hero">
      <div class="logo" aria-hidden="true"></div>
      <h1>Finanz-T√úV</h1>
      <p class="lead">Gef√ºhrter Finanz-Check mit klaren Kategorien ‚Äì reine **Bewertung der Situation**, keine Produktempfehlungen. Auf Wunsch ‚ÄûWhat-if‚Äú-Szenarien & Benchmark-Vergleiche.</p>
      <div style="display:flex; gap:8px; justify-content:center; flex-wrap:wrap">
        <button class="btn" onclick="showPage('wizard'); go(1)">Jetzt starten</button>
        <button class="btn ghost" onclick="loadDemo()">Beispiel laden</button>
      </div>
      <div style="margin-top:14px"><span class="badge">üîß T√úV-Siegel (Beta) ¬∑ an DIN 77230 orientiert</span></div>
    </div>
  </section>

  <!-- Wizard -->
  <section id="wizard" class="page">
    <div class="wizardHead">
      <div style="flex:1">
        <div class="progress"><div class="bar" id="bar"></div></div>
        <div class="pct" id="pct">0%</div>
      </div>
      <div class="muted">Schritt <span id="stepNum">1</span>/<span id="stepTotal">4</span></div>
    </div>

    <!-- Schritt 1: Einnahmen -->
    <div class="panel step" id="step1">
      <h2 style="margin:0 0 8px">Einnahmen</h2>
      <div class="grid2">
        <div><label>Netto-Einkommen (‚Ç¨/Monat)</label><input type="number" id="income" value="3200" step="50"></div>
        <div><label>Sonstige Einnahmen (‚Ç¨/Monat)</label><input type="number" id="otherInc" value="200" step="50"></div>
      </div>
      <div class="nav">
        <button class="btn ghost" onclick="showPage('landing')">‚Üê Abbrechen</button>
        <button class="btn" onclick="next(2)">Weiter</button>
      </div>
    </div>

    <!-- Schritt 2: Ausgaben -->
    <div class="panel step" id="step2" style="display:none">
      <h2 style="margin:0 0 8px">Ausgaben</h2>

      <div class="cat">
        <h3>Fixkosten</h3>
        <div class="grid2">
          <div><label>Wohnen/Miete</label><input type="number" id="rent" value="950" step="50"></div>
          <div><label>Nebenkosten/Energie</label><input type="number" id="utilities" value="200" step="20"></div>
          <div><label>Versicherungen (Pr√§mien)</label><input type="number" id="insPrem" value="60" step="10"></div>
          <div><label>Telefon/Internet</label><input type="number" id="telecom" value="40" step="5"></div>
          <div><label>√ñPNV/Auto (fix)</label><input type="number" id="transportFix" value="120" step="10"></div>
          <div><label>Sonstige Fixkosten</label><input type="number" id="otherFix" value="50" step="10"></div>
        </div>
      </div>

      <div class="cat" style="margin-top:10px">
        <h3>Variabel / Lifestyle</h3>
        <div class="grid2">
          <div><label>Lebensmittel</label><input type="number" id="groceries" value="320" step="20"></div>
          <div><label>Restaurant/To-Go</label><input type="number" id="dining" value="120" step="10"></div>
          <div><label>Freizeit/Shopping</label><input type="number" id="leisure" value="120" step="10"></div>
          <div><label>Abos/Streaming</label><input type="number" id="subscriptions" value="25" step="5"></div>
          <div><label>Mobilit√§t (variabel)</label><input type="number" id="transportVar" value="60" step="10"></div>
          <div><label>Sonstiges variabel</label><input type="number" id="otherVar" value="40" step="10"></div>
        </div>
      </div>

      <div class="nav">
        <button class="btn ghost" onclick="next(1)">‚Üê Zur√ºck</button>
        <button class="btn" onclick="next(3)">Weiter</button>
      </div>
    </div>

    <!-- Schritt 3: Schulden & Notgroschen -->
    <div class="panel step" id="step3" style="display:none">
      <h2 style="margin:0 0 8px">Schulden & Notgroschen</h2>
      <div class="grid2">
        <div><label>Kreditrate(n) mtl.</label><input type="number" id="debtMonthly" value="250" step="10"></div>
        <div><label>Schulden gesamt (‚Ç¨)</label><input type="number" id="debtTotal" value="5000" step="100"></div>
        <div><label>Notgroschen (Betrag ‚Ç¨)</label><input type="number" id="emerg" value="6000" step="100"></div>
        <div><label>Ziel-Runway (Monate)</label><input type="number" id="runwayTarget" value="6" step="1"></div>
      </div>
      <div class="nav">
        <button class="btn ghost" onclick="next(2)">‚Üê Zur√ºck</button>
        <button class="btn" onclick="next(4)">Weiter</button>
      </div>
    </div>

    <!-- Schritt 4: Verm√∂gen & Ziele -->
    <div class="panel step" id="step4" style="display:none">
      <h2 style="margin:0 0 8px">Verm√∂gen & Ziele</h2>
      <div class="cat">
        <h3>Verm√∂gen</h3>
        <div class="grid2">
          <div><label>Cash (au√üer Notgroschen)</label><input type="number" id="cash" value="1000" step="100"></div>
          <div><label>Depot/ETF</label><input type="number" id="invest" value="5000" step="200"></div>
          <div><label>Renten/bAV (Sch√§tzwert)</label><input type="number" id="pension" value="0" step="500"></div>
          <div><label>Immobilien-EK</label><input type="number" id="realestate" value="0" step="500"></div>
        </div>
      </div>
      <div class="cat" style="margin-top:10px">
        <h3>Ziele</h3>
        <div class="grid2">
          <div><label>Wunsch-Rente (Netto ‚Ç¨ / Monat)</label><input type="number" id="retire" value="2000" step="50"></div>
          <div><label>Ziel 1 (Betrag ‚Ç¨)</label><input type="number" id="goal1" value="1000" step="50"></div>
          <div><label>Ziel 2 (Betrag ‚Ç¨)</label><input type="number" id="goal2" value="5000" step="100"></div>
          <div><label>Ziel 3 (Betrag ‚Ç¨)</label><input type="number" id="goal3" value="0" step="100"></div>
        </div>
      </div>
      <div class="nav">
        <button class="btn ghost" onclick="next(3)">‚Üê Zur√ºck</button>
        <div style="display:flex; gap:8px">
          <button class="btn ghost" onclick="resetDefaults()">Zur√ºcksetzen</button>
          <button class="btn" onclick="finish()">Analyse anzeigen ‚Üí</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Ergebnisse -->
  <section id="results" class="page">
    <h2 style="margin:0 0 8px">Ergebnisse & Analyse</h2>
    <div class="kpis" id="kpis"></div>

    <div class="panel">
      <h3 style="margin:0 0 6px">Bewertung (situationsbezogen)</h3>
      <ul id="rating" style="margin:0; padding-left:18px"></ul>
      <div class="muted" style="margin-top:6px">Hinweis: rein indikativ, keine Produktempfehlung. ‚ÄûWhat-if‚Äú siehe unten.</div>
    </div>

    <div class="cols" style="margin-top:10px">
      <div class="panel">
        <h3 style="margin:0 0 6px">Ausgaben-Donut & Projektion</h3>
        <canvas id="pie" height="220"></canvas>
        <div class="legend" id="legend"></div>
        <div class="muted" id="sumTxt" style="margin-top:6px"></div>
        <canvas id="spark" height="64" style="margin-top:8px"></canvas>
        <div class="muted" style="font-size:12px">12-Monats-Projektion: kumuliertes Sparen bei konstantem √úberschuss.</div>
      </div>
      <div class="panel">
        <h3 style="margin:0 0 6px">Verm√∂gen vs. Schulden</h3>
        <canvas id="bars" height="180"></canvas>
        <div class="muted" id="nwText" style="margin-top:6px"></div>
      </div>
    </div>

    <!-- Sparziel-Projektion (interaktiv + Benchmarks) -->
    <div class="panel">
      <h3 style="margin:0 0 6px">What-if: Sparziel & Anlagevergleich</h3>
      <div class="grid2">
        <div><label>Monatlich sparen (‚Ç¨)</label><input type="number" id="msave" value="300" step="10"></div>
        <div><label>Zinssatz p.a. (%) ‚Äì eigenes Szenario</label><input type="number" id="rate" value="5" step="0.1"></div>
        <div><label>Horizont (Jahre)</label><input type="number" id="years" value="10" step="1"></div>
      </div>
      <canvas id="proj" height="200" style="margin-top:8px"></canvas>
      <div class="legend" id="projLegend" style="margin-top:6px"></div>
      <div class="muted" id="projText" style="margin-top:6px"></div>
    </div>

    <div class="panel">
      <h3 style="margin:0 0 6px">Kategorien-Breakdown</h3>
      <ul id="breakdown" style="margin:0; padding-left:18px"></ul>
    </div>

    <div class="panel">
      <h3 style="margin:0 0 6px">Ma√ünahmenplan</h3>
      <ul id="plan" style="margin:0; padding-left:18px"></ul>
    </div>

    <div class="panel">
      <h3 style="margin:0 0 6px">Optional: pers√∂nliche Beratung</h3>
      <p class="muted" style="margin:0 0 8px">Wenn du m√∂chtest, kannst du auf Basis dieser Bewertung 1:1-Beratungszeit buchen (gg. Aufpreis) ‚Äì rein produktneutral.</p>
      <a class="btn" href="mailto:hello@example.com?subject=Finanz-T%C3%9CV%20Beratung&body=Hallo%2C%20ich%20h%C3%A4tte%20gern%20eine%20Beratung%20zu%20meiner%20Analyse.">Beratung anfragen</a>
    </div>

    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px">
      <button class="btn ghost" onclick="showPage('wizard'); go(1)">Eingaben √§ndern</button>
      <button class="btn" onclick="showPage('landing')">Neu starten</button>
    </div>
  </section>

</div>

<script>
/* ===== Helpers ===== */
const byId = (id)=>document.getElementById(id);
const euro = (n)=> (isFinite(n)? n:0).toLocaleString('de-DE',{style:'currency',currency:'EUR',maximumFractionDigits:0});
function sum(o, keys){ return keys.reduce((a,k)=>a+(+o[k]||0),0); }

/* ===== State (mit Defaults) ===== */
let S = {
  // Einnahmen
  income:3200, otherInc:200,
  // Fixkosten
  rent:950, utilities:200, insPrem:60, telecom:40, transportFix:120, otherFix:50,
  // Variabel
  groceries:320, dining:120, leisure:120, subscriptions:25, transportVar:60, otherVar:40,
  // Schulden & Notgroschen
  debtMonthly:250, debtTotal:5000, emerg:6000, runwayTarget:6,
  // Verm√∂gen & Ziele
  cash:1000, invest:5000, pension:0, realestate:0,
  retire:2000, goal1:1000, goal2:5000, goal3:0,
  // Sparziel-Projektion
  msave:300, rate:5, years:10
};
const LS='finanzTuvSiteV1';

/* ===== Navigation & Progress ===== */
const steps = [1,2,3,4]; // step ids
function showPage(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  byId(id).classList.add('active');
  if(id === 'results'){ requestAnimationFrame(renderResults); }
}
function go(n){
  steps.forEach(s=> byId('step'+s).style.display = (s===n)?'block':'none');
  byId('stepNum').textContent = n;
  byId('stepTotal').textContent = steps.length;
  const p = Math.round((n-1)/(steps.length)*100);
  byId('bar').style.width = p+'%';
  byId('pct').textContent = p+'%';
}
function next(n){ persistFromDOM(); go(n); }

/* ===== DOM <-> State ===== */
function fillDefaults(){
  Object.entries(S).forEach(([k,v])=>{
    const el = byId(k); if(el) el.value = v;
  });
}
function persistFromDOM(){
  Object.keys(S).forEach(k=>{
    const el = byId(k); if(!el) return;
    S[k] = el.type==='number' ? (+el.value||0) : el.value;
  });
  localStorage.setItem(LS, JSON.stringify(S));
}
function resetDefaults(){
  localStorage.removeItem(LS);
  S = {
    income:3200, otherInc:200,
    rent:950, utilities:200, insPrem:60, telecom:40, transportFix:120, otherFix:50,
    groceries:320, dining:120, leisure:120, subscriptions:25, transportVar:60, otherVar:40,
    debtMonthly:250, debtTotal:5000, emerg:6000, runwayTarget:6,
    cash:1000, invest:5000, pension:0, realestate:0,
    retire:2000, goal1:1000, goal2:5000, goal3:0,
    msave:300, rate:5, years:10
  };
  fillDefaults();
}

/* ===== Landing buttons ===== */
function loadDemo(){ resetDefaults(); showPage('wizard'); go(1); }

/* ===== Finish -> Analyse ===== */
function finish(){ persistFromDOM(); showPage('results'); }

/* ===== Analyse/Ergebnis ===== */
function medal(x){ return x>=0.8?'gA':x>=0.6?'gB':x>=0.4?'gC':'gD'; }

function renderResults(){
  const incomeTotal = (+S.income||0)+(+S.otherInc||0);
  const fixed = sum(S, ['rent','utilities','insPrem','telecom','transportFix','otherFix']);
  const variable = sum(S, ['groceries','dining','leisure','subscriptions','transportVar','otherVar']);
  const debtPay = +S.debtMonthly||0;
  const totalExp = fixed + variable + debtPay;
  const surplus = incomeTotal - totalExp;
  const savingsRate = incomeTotal>0 ? surplus/incomeTotal : 0;
  const dti = incomeTotal>0 ? debtPay/incomeTotal : 0;
  const runwayMonths = totalExp>0 ? (+S.emerg||0)/totalExp : 0;

  const expectedState = incomeTotal*0.40; // grobe Heuristik
  const pensionGap = Math.max((+S.retire||0) - expectedState, 0);
  const capNeed = pensionGap>0 ? pensionGap*12/0.035 : 0;

  const assets = (+S.cash||0)+(+S.invest||0)+(+S.pension||0)+(+S.realestate||0)+(+S.emerg||0);
  const debts = (+S.debtTotal||0);
  const net = assets - debts;

  // KPIs
  byId('kpis').innerHTML = `
    <div class="kpi"><div class="lab">√úberschuss</div><div class="val">${euro(surplus)}</div><div class="muted">nach allen Ausgaben</div></div>
    <div class="kpi"><div class="lab">Sparquote</div><div class="val">${Math.round(Math.max(0,savingsRate)*100)}%</div><div class="muted">vom Netto</div></div>
    <div class="kpi"><div class="lab">Schuldenquote</div><div class="val">${Math.round(dti*100)}%</div><div class="muted">Rate/Netto</div></div>
    <div class="kpi"><div class="lab">Runway</div><div class="val">${runwayMonths.toFixed(1)} Mo</div><div class="muted">Ziel: ${S.runwayTarget} Mo</div></div>
    ${(+S.retire>0)? `<div class="kpi"><div class="lab">Rente (Heuristik)</div><div class="val">${euro(expectedState)}</div><div class="muted">40% vom Netto</div></div>`:''}
    ${(+S.retire>0)? `<div class="kpi"><div class="lab">Rentenl√ºcke</div><div class="val">${euro(pensionGap)}</div><div class="muted">Kapital ~ ${euro(capNeed)}</div></div>`:''}
  `;

  // Bewertung
  const grdSavings = savingsRate>=.2? 'A': savingsRate>=.1? 'B': savingsRate>0? 'C':'D';
  const grdDTI = dti<=.2? 'A': dti<=.35? 'B': dti<=.5? 'C':'D';
  const runFrac = Math.min((+S.runwayTarget>0? runwayMonths/(+S.runwayTarget):0),1);
  byId('rating').innerHTML = `
    <li> <span class="grade g${grdSavings}">${grdSavings}</span> Sparquote: ${Math.round(Math.max(0,savingsRate)*100)}% ‚Äì Ziel mind. 10%, gut ab 20%.</li>
    <li> <span class="grade g${grdDTI}">${grdDTI}</span> Schuldenquote (DTI): ${Math.round(dti*100)}% ‚Äì < 20% top, 20‚Äì35% ok, > 35% hoch.</li>
    <li> <span class="grade ${'g'+medal(runFrac).toUpperCase()}">${runFrac>=.8?'A':runFrac>=.6?'B':runFrac>=.4?'C':'D'}</span> Notgroschen: ${runwayMonths.toFixed(1)} Monate (Ziel ${S.runwayTarget}).</li>
  `;

  // Donut
  const pie = byId('pie').getContext('2d');
  pie.canvas.width = pie.canvas.clientWidth*devicePixelRatio;
  pie.canvas.height = pie.canvas.clientHeight*devicePixelRatio;
  pie.clearRect(0,0,pie.canvas.width,pie.canvas.height);
  const data = [
    {n:'Fixkosten', v:Math.max(fixed,0), c:'#60a5fa'},
    {n:'Variabel', v:Math.max(variable,0), c:'#a78bfa'},
    {n:'Schulden', v:Math.max(debtPay,0), c:'#fb923c'},
    {n:'√úberschuss', v:Math.max(surplus,0), c:'#34d399'}
  ];
  const total = data.reduce((a,b)=>a+b.v,0) || 1;
  const w = pie.canvas.width, h = pie.canvas.height, cx=w/2, cy=h/2, r=Math.min(w,h)/2 - 12*devicePixelRatio;
  let start=-Math.PI/2;
  data.forEach(d=>{
    const ang = (d.v/total)*Math.PI*2;
    pie.beginPath(); pie.arc(cx,cy,r,start,start+ang);
    pie.strokeStyle = d.c; pie.lineWidth = Math.max(18*devicePixelRatio, r*0.25); pie.lineCap='round'; pie.stroke();
    start+=ang;
  });
  byId('legend').innerHTML = data.map(d=>`<span><span class="dot" style="background:${d.c}"></span> ${d.n}: <b>${euro(d.v)}</b></span>`).join(' ');
  byId('sumTxt').textContent = `Netto ${euro(incomeTotal)} ¬∑ Ausgaben ${euro(totalExp)} ¬∑ √úberschuss ${euro(Math.max(surplus,0))}`;

  // Sparkline
  const sp = byId('spark').getContext('2d');
  sp.canvas.width = sp.canvas.clientWidth*devicePixelRatio; sp.canvas.height = sp.canvas.clientHeight*devicePixelRatio;
  sp.clearRect(0,0,sp.canvas.width,sp.canvas.height);
  const months=12, monthly=Math.max(surplus,0);
  const arr = Array.from({length:months}, (_,i)=> monthly*(i+1));
  const max = Math.max(...arr, 1);
  sp.lineWidth = 2*devicePixelRatio; sp.strokeStyle = '#22d3ee';
  sp.beginPath();
  arr.forEach((v,i)=>{
    const x = (i/(months-1))*(sp.canvas.width-6*devicePixelRatio) + 3*devicePixelRatio;
    const y = sp.canvas.height - (v/max)*(sp.canvas.height-6*devicePixelRatio) - 3*devicePixelRatio;
    if(i===0) sp.moveTo(x,y); else sp.lineTo(x,y);
  });
  sp.stroke();
  const grd = sp.createLinearGradient(0,0,0,sp.canvas.height);
  grd.addColorStop(0,'rgba(34,211,238,.35)'); grd.addColorStop(1,'rgba(34,211,238,0)');
  sp.lineTo(sp.canvas.width-3*devicePixelRatio, sp.canvas.height-3*devicePixelRatio);
  sp.lineTo(3*devicePixelRatio, sp.canvas.height-3*devicePixelRatio);
  sp.closePath(); sp.fillStyle = grd; sp.fill();

  // Bars
  const bars = byId('bars').getContext('2d');
  bars.canvas.width = bars.canvas.clientWidth*devicePixelRatio; bars.canvas.height = bars.canvas.clientHeight*devicePixelRatio;
  bars.clearRect(0,0,bars.canvas.width,bars.canvas.height);
  const vals=[{n:'Verm√∂gen',v:assets,c:'#34d399'},{n:'Schulden',v:debts,c:'#fb7185'},{n:'Netto',v:net,c:'#22d3ee'}];
  const maxb = Math.max(...vals.map(x=>Math.abs(x.v)),1);
  const bw = Math.floor((bars.canvas.width-40*devicePixelRatio)/vals.length);
  vals.forEach((x,i)=>{
    const x0 = 20*devicePixelRatio + i*bw + bw*0.15, wbar = bw*0.7;
    const y0 = bars.canvas.height-20*devicePixelRatio;
    const hbar = Math.round((Math.abs(x.v)/maxb)*(bars.canvas.height-50*devicePixelRatio));
    bars.fillStyle = x.c;
    bars.fillRect(x0, y0-hbar, wbar, hbar);
    bars.fillStyle = '#94a3b8'; bars.font = `${12*devicePixelRatio}px system-ui`; bars.fillText(x.n, x0, y0+12*devicePixelRatio);
  });
  byId('nwText').textContent = `Nettoverm√∂gen: ${euro(net)} (Verm√∂gen ${euro(assets)} / Schulden ${euro(debts)}).`;

  // Breakdown
  const cats = [
    ['Fixkosten', fixed],
    ['Variabel', variable],
    ['Schulden', debtPay]
  ].filter(([_,v])=>v>0).sort((a,b)=>b[1]-a[1]);
  byId('breakdown').innerHTML = cats.map(([n,v])=>{
    const p = totalExp? Math.round(v/totalExp*100):0;
    return `<li>${n}: <b>${euro(v)}</b> (${p}%)</li>`;
  }).join('');

  // Plan
  const plan=[];
  if(surplus<0) plan.push('Defizit: Fixkosten & variable Ausgaben pr√ºfen, Einnahmen erh√∂hen, zuerst √úberschuss herstellen.');
  else if(savingsRate<.10) plan.push('Sparquote > 10% anpeilen (Dauerauftrag direkt nach Geldeingang).');
  else if(savingsRate<.20) plan.push('Solide ‚Äì mittelfristig Richtung 20% gehen.');
  else plan.push('Sehr gute Sparquote ‚Äì Kurs halten.');
  if(runwayMonths < (+S.runwayTarget||6)){
    const need = totalExp*(+S.runwayTarget||6) - (+S.emerg||0);
    plan.push(`Notgroschen auff√ºllen: fehlen ca. ${euro(Math.max(need,0))} f√ºr ${S.runwayTarget} Monate.`);
  }
  if(dti>0.35) plan.push('Schuldenquote >35%: Tilgung/Umschuldung pr√ºfen; variable Ausgaben senken.');
  if(pensionGap>0) plan.push(`Rentenl√ºcke ~ ${euro(pensionGap)}/Monat ‚Üí Kapitalbedarf ~ ${euro(capNeed)} (3,5%-Entnahme).`);
  ['goal1','goal2','goal3'].forEach((g,i)=>{ const v=+S[g]||0; if(v>0) plan.push(`Ziel ${i+1}: ${euro(v)} ‚Äì feste Monatsrate & Zieltermin planen.`); });
  if(plan.length===0) plan.push('Gesamteindruck: solide ‚Äì regelm√§√üig aktualisieren.');
  byId('plan').innerHTML = plan.map(t=>`<li>${t}</li>`).join('');

  // Projection init
  ['msave','rate','years'].forEach(id=>{
    const el = byId(id); if(!el) return;
    el.value = S[id];
    if(!el._bound){ el.addEventListener('input', renderProjection); el._bound = true; }
  });
  requestAnimationFrame(renderProjection);
}

/* ===== Sparziel-/Benchmark-Projektion ===== */
function renderProjection(){
  const m = Math.max(+byId('msave')?.value || +S.msave || 0, 0);
  const rPct = +byId('rate')?.value || +S.rate || 0;
  const y = Math.max(+byId('years')?.value || +S.years || 1, 1);
  S.msave = m; S.rate = rPct; S.years = y; localStorage.setItem(LS, JSON.stringify(S));

  const n = Math.round(y*12);
  const scen = [
    {name:'Einzahlung (0%)', r:0, color:'#94a3b8'},
    {name:`Szenario ${rPct}%`, r:rPct/100, color:'#22d3ee'},
    {name:'2% p.a.', r:0.02, color:'#60a5fa'},
    {name:'5% p.a.', r:0.05, color:'#34d399'},
    {name:'7% p.a.', r:0.07, color:'#fb923c'}
  ];

  // Build series
  const series = scen.map(s=>{
    const rm = Math.pow(1+s.r, 1/12)-1;
    let v=0; const arr=[];
    for(let i=1;i<=n;i++){ v = v*(1+rm)+m; arr.push(v); }
    return {...s, arr};
  });

  const c = byId('proj').getContext('2d');
  c.canvas.width = c.canvas.clientWidth*devicePixelRatio;
  c.canvas.height = c.canvas.clientHeight*devicePixelRatio;
  c.clearRect(0,0,c.canvas.width,c.canvas.height);

  const vmax = Math.max(...series.map(s=> s.arr.at(-1) || 1),1);
  const pad = 6*devicePixelRatio;
  function draw(arr, color){
    c.lineWidth = 2*devicePixelRatio; c.strokeStyle=color; c.beginPath();
    arr.forEach((val,i)=>{
      const x = (i/(arr.length-1))*(c.canvas.width-2*pad)+pad;
      const y = c.canvas.height - (val/vmax)*(c.canvas.height-2*pad) - pad;
      if(i===0) c.moveTo(x,y); else c.lineTo(x,y);
    }); c.stroke();
  }
  series.forEach(s=> draw(s.arr, s.color));

  const base = series[0].arr.at(-1)||0;
  const mine = series[1].arr.at(-1)||0;
  byId('projText').textContent = `Nach ${y} Jahren: Einzahlung ${euro(base)} ¬∑ dein Szenario ${euro(mine)} (Zins-Ertrag ~ ${euro(Math.max(mine-base,0))}).`;
  byId('projLegend').innerHTML = series.map(s=>`<span class="item"><span class="dot" style="background:${s.color}"></span>${s.name}</span>`).join(' ');
}

/* ===== Init ===== */
try{ const saved = JSON.parse(localStorage.getItem(LS)||'null'); if(saved) S = {...S, ...saved}; }catch(e){}
fillDefaults();
go(1);
</script>
</body>
</html>