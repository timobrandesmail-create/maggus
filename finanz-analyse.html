<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0ea5e9">
  <title>Finanzanalyse ‚Äì¬†Pers√∂nlicher Finanz-T√úV</title>
  <meta name="description" content="Umfassender Finanzcheck mit Einnahmen, Ausgaben, Verm√∂gen, Schulden, Versicherungen und Zielen. Eingaben werden offline gespeichert und √ºbersichtlich ausgewertet.">
  <!-- Favicon as inline SVG for easy hosting -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop stop-color="%2306b6d4"/><stop offset="1" stop-color="%2322d3ee"/></linearGradient></defs><rect width="64" height="64" rx="14" fill="black"/><circle cx="32" cy="32" r="20" fill="url(%23g)"/><path d="M18 36l8-10 6 8 8-12 6 8" stroke="white" stroke-width="4" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>' />
  <style>
    /* ------------------
       Design System
       ------------------ */
    :root {
      /* Colours for dark mode */
      --bg: #0b1220;
      --panel: rgba(255,255,255,0.06);
      --ink: #e5e7eb;
      --muted: #94a3b8;
      --ring: rgba(255,255,255,0.12);
      --brand: #22d3ee;
      --good: #10b981;
      --warn: #f59e0b;
      --bad: #ef4444;
      --shadow: 0 10px 30px rgba(2,8,23,0.35);
      --r: 16px;
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f8fafc;
        --panel: #ffffff;
        --ink: #0f172a;
        --muted: #64748b;
        --ring: #e2e8f0;
        --shadow: 0 8px 18px rgba(2,8,23,0.06);
      }
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body {
      font: 16px/1.45 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;
      color: var(--ink);
      background:
        radial-gradient(1200px 600px at 100% -10%, rgba(34,211,238,.15), transparent 60%),
        radial-gradient(1000px 500px at -10% 0%, rgba(99,102,241,.12), transparent 50%),
        var(--bg);
      -webkit-font-smoothing: antialiased;
    }
    .app {
      padding: max(env(safe-area-inset-top),16px) 16px calc(env(safe-area-inset-bottom) + 94px);
      max-width: 800px;
      margin: 0 auto;
    }
    /* Top bar */
    .topbar {
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(0,0,0,.35), transparent);
      padding: 12px 4px 8px;
      margin: -16px -4px 12px;
    }
    .title {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo {
      width: 32px;
      height: 32px;
      border-radius: 9px;
      background: conic-gradient(from 200deg,#67e8f9,#a78bfa,#67e8f9);
      box-shadow: 0 0 0 4px rgba(255,255,255,.06);
    }
    h1 { font-size: 20px; margin: 0; }
    .sub { font-size: 12px; color: var(--muted); margin-top: 2px; }
    /* Panels */
    .panel {
      background: var(--panel);
      border: 1px solid var(--ring);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      margin-top: 14px;
    }
    .panel:first-of-type { margin-top: 0; }
    .in { padding: 14px; }
    .section-title {
      font-weight: 700;
      margin-bottom: 10px;
      font-size: 16px;
    }
    /* Inputs */
    .fields { display: grid; gap: 12px; }
    label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 6px; }
    input[type=number], input[type=text] {
      width: 100%;
      height: 46px;
      border-radius: 12px;
      border: 1px solid var(--ring);
      background: transparent;
      color: var(--ink);
      padding: 0 14px;
      font-size: 16px;
    }
    input:focus {
      outline: 2px solid color-mix(in srgb, var(--brand) 60%, transparent);
    }
    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .grid3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    /* KPI cards */
    .kpis { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; }
    .kpi { border-radius: 14px; padding: 12px; border: 1px solid var(--ring); background: rgba(255,255,255,0.04); }
    .kflex { display: flex; align-items: center; gap: 12px; }
    .gauge {
      --p: 0;
      --col: var(--brand);
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: conic-gradient(var(--col) calc(var(--p)*1%), rgba(255,255,255,.08) 0%);
      display: grid;
      place-items: center;
      font-size: 12px;
      font-weight: 700;
    }
    .kpi .lab { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.06em; }
    .kpi .val { font-size: 20px; font-weight: 700; }
    .tone-good { --col: var(--good); }
    .tone-warn { --col: var(--warn); }
    .tone-bad { --col: var(--bad); }
    /* Charts */
    .chartCard { padding: 10px 10px 4px; }
    canvas { display: block; width: 100%; height: auto; }
    .pie { height: 220px; }
    .bar { height: 220px; margin-top: 20px; }
    .legend { display: flex; flex-wrap: wrap; gap: 10px; margin: 8px 2px 0; font-size: 12px; }
    .dot { width: 10px; height: 10px; border-radius: 50%; }
    .legend .item { display: flex; align-items: center; gap: 6px; }
    /* Buttons */
    .dock {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 20;
      padding: 10px max(env(safe-area-inset-right),16px) calc(env(safe-area-inset-bottom)+10px) max(env(safe-area-inset-left),16px);
    }
    .dockBar {
      max-width: 800px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
      gap: 8px;
    }
    .btn {
      height: 44px;
      border-radius: 12px;
      border: 1px solid var(--ring);
      background: rgba(255,255,255,0.06);
      color: var(--ink);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 14px;
    }
    .btn.primary {
      background: linear-gradient(135deg, #06b6d4, #22d3ee);
      color: #001019;
      font-weight: 700;
    }
    .muted { color: var(--muted); }
    .list { font-size: 14px; }
    .list li { margin: 8px 0; }
    /* Accessibility hidden skip link */
    .sr-only { position: absolute; left: -9999px; top: auto; width: 1px; height: 1px; overflow: hidden; }
    /* Responsive improvements for larger screens */
    @media (min-width: 560px) {
      .grid2 { grid-template-columns: 1fr 1fr; }
      .grid3 { grid-template-columns: 1fr 1fr 1fr; }
    }
    @media print {
      .dock, .topbar { display: none; }
      body { background: #fff; }
      .panel { background: #fff; }
    }
  </style>
</head>
<body>
  <!-- Skip link for accessibility -->
  <a class="sr-only" href="#main">Zum Inhalt springen</a>
  <div class="app" id="main" role="main">
    <header class="topbar" role="banner">
      <div class="title" aria-label="Seitenkopf">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Finanzanalyse</h1>
          <div class="sub">Umfassender pers√∂nlicher Finanzcheck</div>
        </div>
      </div>
    </header>

    <!-- Section: Income -->
    <section class="panel" aria-labelledby="incomeTitle">
      <div class="in">
        <div class="section-title" id="incomeTitle">Einnahmen (Monat)</div>
        <div class="fields">
          <div class="grid2">
            <div>
              <label for="income_primary">Prim√§re Einnahme (‚Ç¨)</label>
              <input id="income_primary" type="number" inputmode="numeric" step="50" placeholder="z. B. 3000" />
            </div>
            <div>
              <label for="income_secondary">Nebenjob / Partner (‚Ç¨)</label>
              <input id="income_secondary" type="number" inputmode="numeric" step="50" placeholder="z. B. 500" />
            </div>
          </div>
          <div class="grid2">
            <div>
              <label for="income_invest">Kapitalertr√§ge (‚Ç¨)</label>
              <input id="income_invest" type="number" inputmode="numeric" step="10" placeholder="z. B. 50" />
            </div>
            <div>
              <label for="income_other">Sonstige Einnahmen (‚Ç¨)</label>
              <input id="income_other" type="number" inputmode="numeric" step="10" placeholder="z. B. 100" />
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Section: Expenses -->
    <section class="panel" aria-labelledby="expTitle">
      <div class="in">
        <div class="section-title" id="expTitle">Ausgaben (Monat)</div>
        <div class="fields">
          <div class="grid2">
            <div>
              <label for="exp_housing">Wohnen (Miete/Kredit) (‚Ç¨)</label>
              <input id="exp_housing" type="number" inputmode="numeric" step="50" placeholder="z. B. 800" />
            </div>
            <div>
              <label for="exp_util">Nebenkosten &amp; Versorger (‚Ç¨)</label>
              <input id="exp_util" type="number" inputmode="numeric" step="10" placeholder="z. B. 200" />
            </div>
          </div>
          <div class="grid2">
            <div>
              <label for="exp_food">Lebensmittel &amp; Essen (‚Ç¨)</label>
              <input id="exp_food" type="number" inputmode="numeric" step="10" placeholder="z. B. 300" />
            </div>
            <div>
              <label for="exp_transport">Mobilit√§t (‚Ç¨)</label>
              <input id="exp_transport" type="number" inputmode="numeric" step="10" placeholder="z. B. 150" />
            </div>
          </div>
          <div class="grid2">
            <div>
              <label for="exp_insurance">Versicherungen (‚Ç¨)</label>
              <input id="exp_insurance" type="number" inputmode="numeric" step="10" placeholder="z. B. 100" />
            </div>
            <div>
              <label for="exp_debt">Schuldenraten (‚Ç¨)</label>
              <input id="exp_debt" type="number" inputmode="numeric" step="10" placeholder="z. B. 200" />
            </div>
          </div>
          <div class="grid2">
            <div>
              <label for="exp_savings">Sparen &amp; Investieren (‚Ç¨)</label>
              <input id="exp_savings" type="number" inputmode="numeric" step="10" placeholder="z. B. 400" />
            </div>
            <div>
              <label for="exp_personal">Pers√∂nliches &amp; Familie (‚Ç¨)</label>
              <input id="exp_personal" type="number" inputmode="numeric" step="10" placeholder="z. B. 150" />
            </div>
          </div>
          <div class="grid2">
            <div>
              <label for="exp_entertain">Freizeit &amp; Unterhaltung (‚Ç¨)</label>
              <input id="exp_entertain" type="number" inputmode="numeric" step="10" placeholder="z. B. 100" />
            </div>
            <div>
              <label for="exp_misc">Sonstiges (‚Ç¨)</label>
              <input id="exp_misc" type="number" inputmode="numeric" step="10" placeholder="z. B. 50" />
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Section: Assets & Liabilities -->
    <section class="panel" aria-labelledby="assetsTitle">
      <div class="in">
        <div class="section-title" id="assetsTitle">Verm√∂gen &amp; Schulden</div>
        <div class="fields">
          <div class="grid2">
            <div>
              <label for="asset_cash">Liquidit√§t (Cash/Tagesgeld) (‚Ç¨)</label>
              <input id="asset_cash" type="number" inputmode="numeric" step="100" placeholder="z. B. 5000" />
            </div>
            <div>
              <label for="asset_invest">Wertpapiere &amp; ETFs (‚Ç¨)</label>
              <input id="asset_invest" type="number" inputmode="numeric" step="100" placeholder="z. B. 10000" />
            </div>
          </div>
          <div class="grid2">
            <div>
              <label for="asset_retire">Altersvorsorge (bAV/R√ºrup etc.) (‚Ç¨)</label>
              <input id="asset_retire" type="number" inputmode="numeric" step="100" placeholder="z. B. 15000" />
            </div>
            <div>
              <label for="asset_property">Immobilien &amp; Eigentum (‚Ç¨)</label>
              <input id="asset_property" type="number" inputmode="numeric" step="100" placeholder="z. B. 200000" />
            </div>
          </div>
          <div class="grid2">
            <div>
              <label for="liab_mortgage">Hypothek/Immokredit (‚Ç¨ Restschuld)</label>
              <input id="liab_mortgage" type="number" inputmode="numeric" step="100" placeholder="z. B. 180000" />
            </div>
            <div>
              <label for="liab_loans">Sonstige Kredite (‚Ç¨ Restschuld)</label>
              <input id="liab_loans" type="number" inputmode="numeric" step="100" placeholder="z. B. 10000" />
            </div>
          </div>
          <div class="grid2">
            <div>
              <label for="liab_credit">Kreditkartensaldo (‚Ç¨)</label>
              <input id="liab_credit" type="number" inputmode="numeric" step="50" placeholder="z. B. 2000" />
            </div>
            <div>
              <label for="liab_student">Bildungskredit/Studienkredit (‚Ç¨)</label>
              <input id="liab_student" type="number" inputmode="numeric" step="100" placeholder="z. B. 5000" />
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Section: Insurance -->
    <section class="panel" aria-labelledby="insTitle">
      <div class="in">
        <div class="section-title" id="insTitle">Versicherungen</div>
        <div class="fields">
          <div class="grid3">
            <div>
              <label for="ins_health">Krankenversicherung (‚Ç¨ mtl.)</label>
              <input id="ins_health" type="number" inputmode="numeric" step="10" placeholder="" />
            </div>
            <div>
              <label for="ins_life">Lebensversicherung (‚Ç¨ mtl.)</label>
              <input id="ins_life" type="number" inputmode="numeric" step="10" placeholder="" />
            </div>
            <div>
              <label for="ins_disability">Berufsunf√§higkeit (‚Ç¨ mtl.)</label>
              <input id="ins_disability" type="number" inputmode="numeric" step="10" placeholder="" />
            </div>
          </div>
          <div class="grid3">
            <div>
              <label for="ins_home">Hausrat / Wohngeb√§ude (‚Ç¨ mtl.)</label>
              <input id="ins_home" type="number" inputmode="numeric" step="10" placeholder="" />
            </div>
            <div>
              <label for="ins_auto">Kfz-Versicherung (‚Ç¨ mtl.)</label>
              <input id="ins_auto" type="number" inputmode="numeric" step="10" placeholder="" />
            </div>
            <div>
              <label for="ins_other">Sonstige Vers. (‚Ç¨ mtl.)</label>
              <input id="ins_other" type="number" inputmode="numeric" step="10" placeholder="" />
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Section: Goals -->
    <section class="panel" aria-labelledby="goalTitle">
      <div class="in">
        <div class="section-title" id="goalTitle">Finanzziele</div>
        <p class="muted" style="font-size: 13px; margin-top: -8px;">Kurzfristige und langfristige Ziele angeben ‚Äì mit Betrag, aktuellem Stand und Zielzeitraum.</p>
        <div class="fields">
          <!-- Goal 1 -->
          <div class="grid3">
            <div>
              <label for="goal1_name">Ziel 1: Beschreibung</label>
              <input id="goal1_name" type="text" placeholder="z. B. Urlaub" />
            </div>
            <div>
              <label for="goal1_target">Zielbetrag (‚Ç¨)</label>
              <input id="goal1_target" type="number" inputmode="numeric" step="50" />
            </div>
            <div>
              <label for="goal1_current">Bisher gespart (‚Ç¨)</label>
              <input id="goal1_current" type="number" inputmode="numeric" step="50" />
            </div>
          </div>
          <div class="grid2">
            <div>
              <label for="goal1_months">Zeitraum (Monate)</label>
              <input id="goal1_months" type="number" inputmode="numeric" step="1" />
            </div>
            <div></div>
          </div>
          <!-- Goal 2 -->
          <div class="grid3">
            <div>
              <label for="goal2_name">Ziel 2: Beschreibung</label>
              <input id="goal2_name" type="text" placeholder="z. B. Autokauf" />
            </div>
            <div>
              <label for="goal2_target">Zielbetrag (‚Ç¨)</label>
              <input id="goal2_target" type="number" inputmode="numeric" step="50" />
            </div>
            <div>
              <label for="goal2_current">Bisher gespart (‚Ç¨)</label>
              <input id="goal2_current" type="number" inputmode="numeric" step="50" />
            </div>
          </div>
          <div class="grid2">
            <div>
              <label for="goal2_months">Zeitraum (Monate)</label>
              <input id="goal2_months" type="number" inputmode="numeric" step="1" />
            </div>
            <div></div>
          </div>
          <!-- Goal 3 -->
          <div class="grid3">
            <div>
              <label for="goal3_name">Ziel 3: Beschreibung</label>
              <input id="goal3_name" type="text" placeholder="z. B. Weiterbildung" />
            </div>
            <div>
              <label for="goal3_target">Zielbetrag (‚Ç¨)</label>
              <input id="goal3_target" type="number" inputmode="numeric" step="50" />
            </div>
            <div>
              <label for="goal3_current">Bisher gespart (‚Ç¨)</label>
              <input id="goal3_current" type="number" inputmode="numeric" step="50" />
            </div>
          </div>
          <div class="grid2">
            <div>
              <label for="goal3_months">Zeitraum (Monate)</label>
              <input id="goal3_months" type="number" inputmode="numeric" step="1" />
            </div>
            <div></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Section: Summary & KPIs -->
    <section class="panel" aria-labelledby="summaryTitle">
      <div class="in">
        <div class="section-title" id="summaryTitle">Kennzahlen</div>
        <div class="kpis" id="kpis"></div>
      </div>
    </section>

    <!-- Section: Charts -->
    <section class="panel" aria-labelledby="chartsTitle">
      <div class="in chartCard">
        <div class="section-title" id="chartsTitle">Visualisierungen</div>
        <!-- Expense Distribution -->
        <canvas class="pie" id="chart_expenses" aria-label="Ausgaben-Verteilung" role="img"></canvas>
        <div class="legend" id="legend_expenses"></div>
        <!-- Net Worth Bar Chart -->
        <canvas class="bar" id="chart_networth" aria-label="Verm√∂gen vs. Schulden" role="img"></canvas>
      </div>
    </section>

    <!-- Section: Plan -->
    <section class="panel" aria-labelledby="planTitle">
      <div class="in">
        <div class="section-title" id="planTitle">Empfehlungen</div>
        <ul class="list" id="plan"></ul>
      </div>
    </section>
  </div>

  <!-- Bottom Action Buttons -->
  <div class="dock" role="contentinfo">
    <div class="dockBar">
      <button class="btn" id="loadSample" type="button">‚ú® Beispiel</button>
      <button class="btn" id="resetAll" type="button">‚Ü∫ Reset</button>
      <button class="btn" id="shareBtn" type="button">üîó Teilen</button>
      <button class="btn primary" id="saveBtn" type="button">‚¨áÔ∏é Speichern</button>
    </div>
  </div>

  <script>
    /* ========= Data model ========= */
    const state = {
      income_primary: 3000,
      income_secondary: 500,
      income_invest: 50,
      income_other: 100,
      exp_housing: 800,
      exp_util: 200,
      exp_food: 300,
      exp_transport: 150,
      exp_insurance: 100,
      exp_debt: 200,
      exp_savings: 400,
      exp_personal: 150,
      exp_entertain: 100,
      exp_misc: 50,
      asset_cash: 5000,
      asset_invest: 10000,
      asset_retire: 15000,
      asset_property: 200000,
      liab_mortgage: 180000,
      liab_loans: 10000,
      liab_credit: 2000,
      liab_student: 5000,
      ins_health: 200,
      ins_life: 50,
      ins_disability: 30,
      ins_home: 40,
      ins_auto: 60,
      ins_other: 20,
      goal1_name: 'Urlaub',
      goal1_target: 3000,
      goal1_current: 500,
      goal1_months: 12,
      goal2_name: 'Autokauf',
      goal2_target: 15000,
      goal2_current: 2000,
      goal2_months: 24,
      goal3_name: 'Weiterbildung',
      goal3_target: 5000,
      goal3_current: 0,
      goal3_months: 18
    };

    const LS_KEY = 'finanzAnalyseV1';

    /* ========= Utility functions ========= */
    const $$ = id => document.getElementById(id);
    const euro = n => (isFinite(n)? n : 0).toLocaleString('de-DE',{ style:'currency', currency:'EUR', maximumFractionDigits:0 });
    const percent = n => Math.round(n*100) + '%';
    const sum = arr => arr.reduce((a,b) => a + (parseFloat(b) || 0), 0);

    /* ========= Read values from inputs into state ========= */
    function readInputs() {
      Object.keys(state).forEach(key => {
        const el = $$(key);
        if (!el) return;
        if (el.type === 'number') {
          state[key] = parseFloat(el.value) || 0;
        } else if (el.type === 'text') {
          state[key] = el.value || '';
        }
      });
    }

    /* ========= Write state values into inputs ========= */
    function writeInputs() {
      Object.keys(state).forEach(key => {
        const el = $$(key);
        if (el) {
          if (el.type === 'number') {
            el.value = state[key];
          } else if (el.type === 'text') {
            el.value = state[key];
          }
        }
      });
    }

    /* ========= Calculations ========= */
    function calculateMetrics() {
      // Income
      const totalIncome = sum([
        state.income_primary,
        state.income_secondary,
        state.income_invest,
        state.income_other
      ]);
      // Expenses categories
      const expenses = {
        Wohnen: state.exp_housing,
        Nebenkosten: state.exp_util,
        Lebensmittel: state.exp_food,
        Mobilit√§t: state.exp_transport,
        Versicherungen: state.exp_insurance + sum([
          state.ins_health,
          state.ins_life,
          state.ins_disability,
          state.ins_home,
          state.ins_auto,
          state.ins_other
        ]),
        Schulden: state.exp_debt,
        Sparen: state.exp_savings,
        Pers√∂nlich: state.exp_personal,
        Freizeit: state.exp_entertain,
        Sonstiges: state.exp_misc
      };
      const totalExpenses = Object.values(expenses).reduce((a,b)=>a+(parseFloat(b)||0),0);
      // Non-savings expenses for emergency fund calculation (exclude savings)
      const nonSavingsExpenses = totalExpenses - state.exp_savings;
      // Surplus / deficit
      const surplus = totalIncome - totalExpenses;
      const savingsRate = totalIncome>0 ? state.exp_savings / totalIncome : 0;
      const debtServiceRatio = totalIncome>0 ? state.exp_debt / totalIncome : 0;
      // Assets and liabilities
      const totalAssets = sum([
        state.asset_cash,
        state.asset_invest,
        state.asset_retire,
        state.asset_property
      ]);
      const totalLiabilities = sum([
        state.liab_mortgage,
        state.liab_loans,
        state.liab_credit,
        state.liab_student
      ]);
      const netWorth = totalAssets - totalLiabilities;
      // Emergency fund months
      const emergencyMonths = nonSavingsExpenses > 0 ? state.asset_cash / nonSavingsExpenses : 0;
      // Goals calculations
      const goals = [];
      for (let i=1; i<=3; i++) {
        const name = state['goal'+i+'_name'];
        const target = state['goal'+i+'_target'];
        const current = state['goal'+i+'_current'];
        const months = state['goal'+i+'_months'];
        if (name && target > 0 && months > 0) {
          const remaining = Math.max(target - current, 0);
          const neededPerMonth = remaining / months;
          goals.push({ name, target, current, months, neededPerMonth, remaining });
        }
      }
      // Return metrics
      return {
        totalIncome,
        expenses,
        totalExpenses,
        nonSavingsExpenses,
        surplus,
        savingsRate,
        debtServiceRatio,
        totalAssets,
        totalLiabilities,
        netWorth,
        emergencyMonths,
        goals
      };
    }

    /* ========= Render KPI gauges ========= */
    function renderKPIs(metrics) {
      const kpisEl = $$('kpis');
      kpisEl.innerHTML = '';
      // Determine tone classes for each gauge
      const tone = {};
      tone.savings = metrics.savingsRate >= 0.2 ? 'good' : metrics.savingsRate >= 0.1 ? 'warn' : 'bad';
      tone.debt = metrics.debtServiceRatio <= 0.2 ? 'good' : metrics.debtServiceRatio <= 0.35 ? 'warn' : 'bad';
      tone.cashflow = metrics.surplus >= 0 ? 'good' : Math.abs(metrics.surplus) < metrics.totalIncome*0.05 ? 'warn' : 'bad';
      tone.emergency = metrics.emergencyMonths >= 6 ? 'good' : metrics.emergencyMonths >= 3 ? 'warn' : 'bad';
      tone.networth = metrics.netWorth >= 0 ? 'good' : 'bad';
      // Gauges list
      const gauges = [];
      gauges.push({label: 'Cashflow', value: euro(metrics.surplus), frac: Math.min(Math.abs(metrics.surplus)/(metrics.totalIncome||1),1), tone: tone.cashflow, hint: metrics.surplus >= 0 ? '√úberschuss' : 'Defizit' });
      gauges.push({label: 'Sparquote', value: percent(metrics.savingsRate), frac: metrics.savingsRate, tone: tone.savings, hint: 'Anteil vom Netto' });
      gauges.push({label: 'Schuldendienst', value: percent(metrics.debtServiceRatio), frac: 1 - Math.min(metrics.debtServiceRatio,1), tone: tone.debt, hint: 'DTI' });
      gauges.push({label: 'Notgroschen', value: metrics.emergencyMonths.toFixed(1)+' Mo', frac: Math.min(metrics.emergencyMonths/6, 1), tone: tone.emergency, hint: 'Ziel ‚â• 6' });
      gauges.push({label: 'Nettoverm√∂gen', value: euro(metrics.netWorth), frac: metrics.netWorth >= 0 ? 1 : 0, tone: tone.networth, hint: metrics.netWorth >= 0 ? 'Positiv' : 'Negativ' });
      gauges.forEach(g => {
        const div = document.createElement('div');
        div.className = 'kpi ' + g.tone;
        div.innerHTML = `<div class="kflex"><div class="gauge tone-${g.tone}" style="--p:${Math.round(g.frac*100)}">${Math.round(g.frac*100)}<span style="font-size:10px">%</span></div><div><div class="lab">${g.label}</div><div class="val">${g.value}</div>${g.hint?`<div class="muted" style="font-size:11px">${g.hint}</div>`:''}</div></div>`;
        kpisEl.appendChild(div);
      });
      // Additional KPI for assets and liabilities
      const ratio = metrics.totalAssets > 0 ? metrics.totalLiabilities / metrics.totalAssets : 1;
      const toneNet = ratio <= 0.3 ? 'good' : ratio <= 0.6 ? 'warn' : 'bad';
      const kpiNet = document.createElement('div');
      kpiNet.className = 'kpi ' + toneNet;
      const pctNet = Math.max(0, Math.min(100, Math.round((1-ratio)*100)));
      kpiNet.innerHTML = `<div class="kflex"><div class="gauge tone-${toneNet}" style="--p:${pctNet}">${pctNet}<span style="font-size:10px">%</span></div><div><div class="lab">Verm√∂gen</div><div class="val">${euro(metrics.totalAssets)}</div><div class="muted" style="font-size:11px">Schulden: ${euro(metrics.totalLiabilities)}</div></div></div>`;
      kpisEl.appendChild(kpiNet);
    }

    /* ========= Render Charts ========= */
    function renderCharts(metrics) {
      // Expense Distribution Pie
      const pieCanvas = $$('chart_expenses');
      const ctxPie = pieCanvas.getContext('2d');
      const wPie = pieCanvas.width = pieCanvas.clientWidth * devicePixelRatio;
      const hPie = pieCanvas.height = pieCanvas.clientHeight * devicePixelRatio;
      const cx = wPie/2;
      const cy = hPie/2;
      const r = Math.min(wPie,hPie)/2 - 12*devicePixelRatio;
      ctxPie.clearRect(0,0,wPie,hPie);
      const data = Object.entries(metrics.expenses).filter(([k,v]) => v > 0);
      const total = data.reduce((a,[_,v]) => a + v, 0) || 1;
      let startAng = -Math.PI/2;
      const colors = ['#60a5fa','#fb923c','#34d399','#a78bfa','#f472b6','#facc15','#5eead4','#f87171','#c084fc','#fde047'];
      data.forEach(([cat,val],i) => {
        const ang = (val/total)*Math.PI*2;
        ctxPie.beginPath();
        ctxPie.arc(cx, cy, r, startAng, startAng + ang);
        ctxPie.strokeStyle = colors[i % colors.length];
        ctxPie.lineWidth = Math.max(18*devicePixelRatio, r*0.25);
        ctxPie.lineCap = 'round';
        ctxPie.stroke();
        startAng += ang;
      });
      // Legend for expenses
      const legendEl = $$('legend_expenses');
      legendEl.innerHTML = data.map(([cat,val],i) => `<span class="item"><span class="dot" style="background:${colors[i % colors.length]}"></span>${cat}: <b>${euro(val)}</b></span>`).join('');
      // Net worth bar chart
      const barCanvas = $$('chart_networth');
      const ctxBar = barCanvas.getContext('2d');
      const wBar = barCanvas.width = barCanvas.clientWidth * devicePixelRatio;
      const hBar = barCanvas.height = barCanvas.clientHeight * devicePixelRatio;
      ctxBar.clearRect(0,0,wBar,hBar);
      const labels = ['Verm√∂gen','Schulden','Netto'];
      const values = [metrics.totalAssets, metrics.totalLiabilities, metrics.netWorth];
      const maxVal = Math.max(...values.map(v => Math.abs(v)), 1);
      const barWidth = wBar / (labels.length*2);
      const baseY = hBar * 0.85;
      ctxBar.fillStyle = 'rgba(255,255,255,0.06)';
      ctxBar.fillRect(0,0,wBar,hBar);
      values.forEach((val, i) => {
        const x = (i*2 + 1)*barWidth;
        const barHeight = (Math.abs(val)/maxVal)*(hBar*0.6);
        const y = baseY - (val >= 0 ? barHeight : 0);
        ctxBar.fillStyle = val >= 0 ? '#34d399' : '#f87171';
        ctxBar.fillRect(x - barWidth*0.5, y, barWidth, barHeight);
        // Label
        ctxBar.fillStyle = getComputedStyle(document.body).getPropertyValue('--ink');
        ctxBar.font = `${14*devicePixelRatio}px sans-serif`;
        ctxBar.textAlign = 'center';
        ctxBar.fillText(euro(val), x, val >= 0 ? y - 8*devicePixelRatio : y + barHeight + 16*devicePixelRatio);
        ctxBar.fillText(labels[i], x, baseY + 24*devicePixelRatio);
      });
    }

    /* ========= Render Plan / Recommendations ========= */
    function renderPlan(metrics) {
      const planEl = $$('plan');
      const items = [];
      // Cashflow
      if (metrics.surplus < 0) {
        items.push(`<li><b>Cashflow:</b> Dein Budget ist im roten Bereich. K√ºrze variable Ausgaben (z.‚ÄØB. Freizeit, Sonstiges) oder erh√∂he deine Einnahmen, um den Defizit von ${euro(-metrics.surplus)} zu schlie√üen.</li>`);
      } else if (metrics.surplus < metrics.totalIncome * 0.05) {
        items.push(`<li><b>Cashflow:</b> Dein monatlicher √úberschuss (${euro(metrics.surplus)}) ist gering. Nutze einen Haushaltsplan und streiche kleine Ausgaben, um deine Sparquote zu erh√∂hen.</li>`);
      } else {
        items.push(`<li><b>Cashflow:</b> Du hast einen gesunden √úberschuss von ${euro(metrics.surplus)} pro Monat. Teile ihn zwischen Sparen/Investieren und Schuldenabbau auf.</li>`);
      }
      // Savings Rate
      if (metrics.savingsRate < 0.1) {
        items.push(`<li><b>Sparen:</b> Deine Sparquote (${percent(metrics.savingsRate)}) liegt unter dem empfohlenen Minimum (10&nbsp;%). Pr√ºfe, ob du Sparpotenzial hast (z.‚ÄØB. Abos k√ºndigen) und erh√∂he deine R√ºcklagen.</li>`);
      } else if (metrics.savingsRate < 0.2) {
        items.push(`<li><b>Sparen:</b> Eine solide Quote (${percent(metrics.savingsRate)}). Versuche, langfristig 20&nbsp;% deines Nettoeinkommens zu sparen.</li>`);
      } else {
        items.push(`<li><b>Sparen:</b> Super! Mit ${percent(metrics.savingsRate)} bist du auf einem sehr guten Kurs. Behalte diese Disziplin bei.</li>`);
      }
      // Debt
      if (metrics.debtServiceRatio > 0.35) {
        items.push(`<li><b>Schulden:</b> Deine Schuldendienstquote (${percent(metrics.debtServiceRatio)}) ist hoch. Pr√ºfe, ob du Kredite umschulden oder schneller tilgen kannst. Reduziere neue Schulden.</li>`);
      } else if (metrics.debtServiceRatio > 0.2) {
        items.push(`<li><b>Schulden:</b> Achte darauf, die Schuldenlast schrittweise zu senken und nicht weiter zu erh√∂hen.</li>`);
      } else {
        items.push(`<li><b>Schulden:</b> Deine Schuldenlast ist im gr√ºnen Bereich. Behalte gute Gewohnheiten bei und tilge laufende Kredite wie geplant.</li>`);
      }
      // Emergency fund
      if (metrics.emergencyMonths < 3) {
        items.push(`<li><b>Notgroschen:</b> Deine R√ºcklagen reichen f√ºr ${metrics.emergencyMonths.toFixed(1)} Monate. Ziel: 3‚Äì6 Monate deiner laufenden Ausgaben beiseite legen. Baue deine liquide Reserve weiter auf.</li>`);
      } else if (metrics.emergencyMonths < 6) {
        items.push(`<li><b>Notgroschen:</b> Solide Reserve (${metrics.emergencyMonths.toFixed(1)} Monate). Setze dir das Ziel, auf mindestens 6 Monate zu kommen.</li>`);
      } else {
        items.push(`<li><b>Notgroschen:</b> Sehr gut! Dein Puffer von ${metrics.emergencyMonths.toFixed(1)} Monaten deckt Notf√§lle ab.</li>`);
      }
      // Goals
      metrics.goals.forEach(g => {
        items.push(`<li><b>Ziel ‚Äû${g.name}‚Äú:</b> Du brauchst ${euro(g.neededPerMonth)} pro Monat, um ${euro(g.remaining)} in ${g.months} Monaten zu erreichen. Pr√ºfe, ob dein aktuelles Budget das zul√§sst.</li>`);
      });
      // Net worth
      if (metrics.netWorth < 0) {
        items.push(`<li><b>Verm√∂gen:</b> Dein Nettoverm√∂gen ist negativ. Fokussiere dich auf Schuldenabbau und Verm√∂gensaufbau √ºber monatliches Sparen und Investieren.</li>`);
      } else {
        items.push(`<li><b>Verm√∂gen:</b> Positives Nettoverm√∂gen (${euro(metrics.netWorth)}). Weiter so ‚Äì diversifiziere dein Portfolio und bleib langfristig investiert.</li>`);
      }
      planEl.innerHTML = items.join('');
    }

    /* ========= Event Handlers ========= */
    function updateAll() {
      readInputs();
      const metrics = calculateMetrics();
      renderKPIs(metrics);
      renderCharts(metrics);
      renderPlan(metrics);
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    }
    // Attach input listeners
    document.querySelectorAll('input').forEach(el => {
      el.addEventListener('input', () => { updateAll(); });
    });

    // Load sample data
    $$("loadSample").addEventListener('click', () => {
      Object.assign(state, {
        income_primary: 3500,
        income_secondary: 500,
        income_invest: 50,
        income_other: 150,
        exp_housing: 900,
        exp_util: 220,
        exp_food: 350,
        exp_transport: 180,
        exp_insurance: 120,
        exp_debt: 250,
        exp_savings: 500,
        exp_personal: 200,
        exp_entertain: 120,
        exp_misc: 70,
        asset_cash: 7000,
        asset_invest: 15000,
        asset_retire: 20000,
        asset_property: 220000,
        liab_mortgage: 170000,
        liab_loans: 8000,
        liab_credit: 1500,
        liab_student: 4000,
        ins_health: 250,
        ins_life: 60,
        ins_disability: 40,
        ins_home: 50,
        ins_auto: 80,
        ins_other: 30,
        goal1_name: 'Urlaub', goal1_target: 4000, goal1_current: 800, goal1_months: 10,
        goal2_name: 'Autokauf', goal2_target: 18000, goal2_current: 3000, goal2_months: 24,
        goal3_name: 'Weiterbildung', goal3_target: 6000, goal3_current: 200, goal3_months: 18
      });
      writeInputs();
      updateAll();
    });
    // Reset all inputs
    $$("resetAll").addEventListener('click', () => {
      Object.keys(state).forEach(k => {
        if (typeof state[k] === 'number') state[k] = 0;
        else state[k] = '';
      });
      state.goal1_months = state.goal2_months = state.goal3_months = 0;
      writeInputs();
      updateAll();
    });
    // Share (simple: copy link or alert for local file)
    $$("shareBtn").addEventListener('click', async () => {
      const shareText = 'Teste meinen Finanzanalyse-Report! √ñffne die HTML-Datei im Browser und gib deine eigenen Daten ein.';
      if (navigator.share) {
        try { await navigator.share({ title: 'Finanzanalyse', text: shareText }); } catch (e) {}
      } else {
        alert('Kopiere die URL oder Datei und teile sie via Messenger/E-Mail.');
      }
    });
    // Save HTML
    $$("saveBtn").addEventListener('click', () => {
      const blob = new Blob([document.documentElement.outerHTML], { type:'text/html' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'finanzanalyse.html';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    /* ========= Initialization ========= */
    function init() {
      // Load from localStorage
      try {
        const saved = JSON.parse(localStorage.getItem(LS_KEY));
        if (saved) {
          Object.assign(state, saved);
        }
      } catch(e){}
      writeInputs();
      updateAll();
    }
    init();
  </script>
</body>
</html>